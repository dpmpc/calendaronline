{% extends "master.html" %}
{% load static %}
{% load prefix %}

{% block title %}
  Neuen Kalender erzeugen
{% endblock %}

{% block head %}
  <link  href="{% static 'cropper.js-1.6.2/cropper.min.css' %}" rel="stylesheet">
  <script src="{% static 'cropper.js-1.6.2/cropper.min.js' %}">
    import Cropper from 'cropperjs';
  </script>
{% endblock %}

{% block content %}
<form enctype="multipart/form-data" name="months">
  {% csrf_token %} 
  <input type="hidden" name="format" value="{{ format }}" />
  <input type="hidden" name="ids" value="{% for month in months %}{{month.id}},{% endfor %}" />
  <input type="hidden" name="lenght" value="{{ months|length }}" />
  <input type="hidden" name="save_project" value="0" />

  <ul class="nav nav-tabs" id="monthTabs" role="tablist">
    {% for month in months %}
      <li class="nav-item" role="presentation">
        <button class="nav-link{% if forloop.first %} active{% endif %}" id="month_tab_{{ month.id }}" data-bs-toggle="tab" data-bs-target="#month_pane_{{ month.id }}" type="button" role="tab" aria-controls="month_pane_{{ month.id }}" aria-selected="{% if forloop.first %}true{% else %}false{% endif %}">{{ month.name }}</button>
      </li>  
    {% endfor %}
  </ul>
  <div class="tab-content" id="monthTabsContent">
    {% for month in months %}
      <div class="tab-pane fade{% if forloop.first %} show active{% endif %}" id="month_pane_{{ month.id }}" role="tabpanel" aria-labelledby="month_tab_{{ month.id }}" tabindex="0">
        <input type="hidden" name="id_{{ month.id }}" value="{{ month.id }}" />
        <input type="hidden" name="name_{{ month.id }}" value="{{ month.name }}" />
        <input type="hidden" name="date_{{ month.id }}" value="{{ month.date | date:'Y-m-d' }}" />
        
        <div class="container-fluid pt-3">
          <div class="row mb-3">
            <div class="col text-center">
                <img id="image-preview-{{ month.id }}" src="{% static 'images/no_image_16x9.png' %}" alt="Vorschau" class="img-fluid" style="max-height:700px">
            </div>
          </div>
    
          <div class="row mb-3 text-center">
            <div class="col docs-buttons">
              <!-- <h3>Toolbar:</h3> -->
              <div class="btn-group">
                <button type="button" class="btn btn-success" title="Neues Bild öffnen" onclick="selectImage('{{ month.id }}', '{{month.image_aspect_ratio}}')">
                  <span class="fa fa-file-image"></span> Bild öffnen
                </button>
              </div>
      
              <!--
              <div class="btn-group">
                <button type="button" class="btn btn-primary" title="Zoom vergrößern" disabled>
                  <span class="fa fa-search-plus"></span>
                </button>
                <button type="button" class="btn btn-primary" title="Zoom verkleinern" disabled>
                  <span class="fa fa-search-minus"></span>
                </button>
              </div>
      
              <div class="btn-group">
                <button type="button" class="btn btn-primary" title="Nach links drehen" disabled>
                  <span class="fa fa-undo-alt"></span>
                </button>
                <button type="button" class="btn btn-primary" title="Nach rechts drehen" disabled>
                  <span class="fa fa-redo-alt"></span>
                </button>
              </div>
      
              <div class="btn-group">
                <button type="button" class="btn btn-primary" title="Horizontal spiegeln" disabled>
                  <span class="fa fa-arrows-alt-h"></span>
                </button>
                <button type="button" class="btn btn-primary" title="Vertikal spiegeln" disabled>
                  <span class="fa fa-arrows-alt-v"></span>
                </button>
              </div>

              <div class="btn-group">
                <button type="button" id="button-save-{{ month.id }}" class="btn btn-primary" title="Projekt Speichern" onclick="uploadImages(true)">
                  <span class="fa fa-floppy-disk"></span> Speichern
                </button>
              </div>

              -->

              <div class="btn-group">
                <button type="button" id="button-preview-{{ month.id }}" class="btn btn-primary" title="Vorschau" onclick="uploadImages([ {{ month.id }} ])" disabled>
                  <span class="fa fa-eye"></span> Vorschau
                </button>
                <button type="button" class="btn {% if forloop.last %}btn-success{% else %}btn-primary{% endif %}" title="Kalender erzeugen" onclick="uploadImages()">
                  <span class="fa fa-file-pdf"></span> Kalender Erzeugen
                </button>
              </div>
                
              <div class="btn-group">
                <button type="button" class="btn btn-primary" title="Nächster Monat" onclick="showTab('month_tab_{{ month.id|add:1}}')"{% if forloop.last %} disabled{% endif %}>
                  <span class="fa fa-arrow-circle-right"></span> Nächster Monat
                </button>
              </div>
            </div>
          </div>
      
          <h5 class="mb-3">Optionen für den Monat</h5>

          {% include "creator/options_general.html" with fieldpostfix=month.id|prefix:"_" month=month %}

          {% if month.supports_events %} 
          <h5 class="mb-3">Termine</h5>
          <div class="list-group" id="events-group-{{ month.id }}">
          </div>

          <div class="row  pt-3">
            <div class="col docs-buttons">
              <button type="button" class="btn btn-primary" onclick="addEvent({{ month.id }}, '{{ month.date | date:'Y-m-d' }}', '')" >
                <span class="fa fa-calendar-plus"></span> Termin hinzufügen
              </button>
            </div>
          </div>
          
          {% endif %} 

        </div>
      </div>
      
    {% endfor %}
  </div>
 
</form>
<!-- Modal -->
<div class="modal fade" id="upload-images-modal" tabindex="-1" aria-labelledby="upload-images-modal-label" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="upload-images-modal-label">Lade Bilder zum Server</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="progress">
          <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-label="Fortschritt" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%">0%</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>

const cropper = [];
let globalAppointmentId = 0;
let months = [ {% for month in months %}{{ month.id}}{% if not forloop.last %},{% endif %}{% endfor %} ];

{% if months.0.supports_events %}
$( document ).ready(function() {
  {% for month in months %}
    {% for event in month.events %}
    addEvent({{month.id}}, '{{ event.date }}', '{{ event.text }}', true);
    {% endfor %}
    {% if month.image %}setCropperImage('{{ month.id }}', '{{month.image_aspect_ratio}}', false, 'data:image/jpeg;base64,{{ month.image }}'){% endif %}
  {% endfor %}
});
{% endif %} 
</script>
<script src="{% static 'calendaronline.js' %}"></script>
{% endblock %}