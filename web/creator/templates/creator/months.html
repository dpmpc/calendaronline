{% extends "master.html" %}
{% load static %}
{% load prefix %}

{% block title %}
  Neuen Kalender erzeugen
{% endblock %}

{% block head %}
  <link href="{% static 'cropper.js-1.6.2/cropper.min.css' %}" rel="stylesheet">
  <link href="{% static 'ribbon.css' %}" rel="stylesheet">
  <script src="{% static 'cropper.js-1.6.2/cropper.min.js' %}">
    import Cropper from 'cropperjs';
  </script>
{% endblock %}

{% block ribbon %}
  {% include "creator/ribbon.html" %}
{% endblock %}

{% block content %}
<form enctype="multipart/form-data" name="months">
  {% csrf_token %} 
  <input type="hidden" name="format" value="{{ format }}" />
  <input type="hidden" name="ids" value="{% for month in months %}{{month.id}},{% endfor %}" />
  <input type="hidden" name="lenght" value="{{ months|length }}" />
  <input type="hidden" name="save_project" value="0" />

  <!-- Month Content Panels -->
  <div id="monthPanelsContent">
    {% for month in months %}
      <div class="month-panel{% if not forloop.first %} d-none{% endif %}" id="month_panel_{{ month.id }}" data-month-id="{{ month.id }}">
        <input type="hidden" name="id_{{ month.id }}" value="{{ month.id }}" />
        <input type="hidden" name="name_{{ month.id }}" value="{{ month.name }}" />
        <input type="hidden" name="date_{{ month.id }}" value="{{ month.date | date:'Y-m-d' }}" />
        
        <!-- Hidden fields for ribbon-controlled values -->
        <input type="hidden" name="image_border_{{ month.id }}" id="field_image_border_{{ month.id }}" value="{% if month.image_border %}1{% endif %}" />
        <input type="hidden" name="image_border_color_{{ month.id }}" id="field_image_border_color_{{ month.id }}" value="{{ month.image_border_color }}" />
        <input type="hidden" name="image_border_width_{{ month.id }}" id="field_image_border_width_{{ month.id }}" value="{{ month.image_border_width }}" />
        <input type="hidden" name="background_type_{{ month.id }}" id="field_background_type_{{ month.id }}" value="{{ month.background_type }}" />
        <input type="hidden" name="background_color_{{ month.id }}" id="field_background_color_{{ month.id }}" value="{{ month.background_color }}" />
        <input type="hidden" name="background_color_b_{{ month.id }}" id="field_background_color_b_{{ month.id }}" value="{{ month.background_color_b }}" />
        <input type="hidden" name="center_month_{{ month.id }}" id="field_center_month_{{ month.id }}" value="{% if month.month_align == 'C' %}1{% endif %}" />
        <input type="hidden" name="table_border_{{ month.id }}" id="field_table_border_{{ month.id }}" value="{% if month.table_border %}1{% endif %}" />
        <input type="hidden" name="show_weeks_{{ month.id }}" id="field_show_weeks_{{ month.id }}" value="{% if month.show_weeks %}1{% endif %}" />
        <input type="hidden" name="table_background_color_{{ month.id }}" id="field_table_background_color_{{ month.id }}" value="{{ month.table_background_color }}" />
        <input type="hidden" name="table_background_opacity_{{ month.id }}" id="field_table_background_opacity_{{ month.id }}" value="{{ month.table_background_opacity }}" />
        {% if month.supports_fonts %}
        <input type="hidden" name="font_weekday_bold_{{ month.id }}" id="field_font_weekday_bold_{{ month.id }}" value="{% if month.fonts.weekday.bold %}1{% endif %}" />
        <input type="hidden" name="font_weekday_italic_{{ month.id }}" id="field_font_weekday_italic_{{ month.id }}" value="{% if month.fonts.weekday.italic %}1{% endif %}" />
        <input type="hidden" name="font_weekday_underline_{{ month.id }}" id="field_font_weekday_underline_{{ month.id }}" value="{% if month.fonts.weekday.underline %}1{% endif %}" />
        <input type="hidden" name="font_weekday_color_{{ month.id }}" id="field_font_weekday_color_{{ month.id }}" value="{{ month.fonts.weekday.color }}" />
        <input type="hidden" name="font_saturday_bold_{{ month.id }}" id="field_font_saturday_bold_{{ month.id }}" value="{% if month.fonts.saturday.bold %}1{% endif %}" />
        <input type="hidden" name="font_saturday_italic_{{ month.id }}" id="field_font_saturday_italic_{{ month.id }}" value="{% if month.fonts.saturday.italic %}1{% endif %}" />
        <input type="hidden" name="font_saturday_underline_{{ month.id }}" id="field_font_saturday_underline_{{ month.id }}" value="{% if month.fonts.saturday.underline %}1{% endif %}" />
        <input type="hidden" name="font_saturday_color_{{ month.id }}" id="field_font_saturday_color_{{ month.id }}" value="{{ month.fonts.saturday.color }}" />
        <input type="hidden" name="font_sunday_bold_{{ month.id }}" id="field_font_sunday_bold_{{ month.id }}" value="{% if month.fonts.sunday.bold %}1{% endif %}" />
        <input type="hidden" name="font_sunday_italic_{{ month.id }}" id="field_font_sunday_italic_{{ month.id }}" value="{% if month.fonts.sunday.italic %}1{% endif %}" />
        <input type="hidden" name="font_sunday_underline_{{ month.id }}" id="field_font_sunday_underline_{{ month.id }}" value="{% if month.fonts.sunday.underline %}1{% endif %}" />
        <input type="hidden" name="font_sunday_color_{{ month.id }}" id="field_font_sunday_color_{{ month.id }}" value="{{ month.fonts.sunday.color }}" />
        <input type="hidden" name="font_event_bold_{{ month.id }}" id="field_font_event_bold_{{ month.id }}" value="{% if month.fonts.event.bold %}1{% endif %}" />
        <input type="hidden" name="font_event_italic_{{ month.id }}" id="field_font_event_italic_{{ month.id }}" value="{% if month.fonts.event.italic %}1{% endif %}" />
        <input type="hidden" name="font_event_underline_{{ month.id }}" id="field_font_event_underline_{{ month.id }}" value="{% if month.fonts.event.underline %}1{% endif %}" />
        <input type="hidden" name="font_event_color_{{ month.id }}" id="field_font_event_color_{{ month.id }}" value="{{ month.fonts.event.color }}" />
        {% endif %}
        
        <!-- Full-width Image Cropper -->
        <div class="cropper-container-fullwidth">
          <img id="image-preview-{{ month.id }}" src="{% static 'images/no_image_16x9.png' %}" alt="Vorschau" class="cropper-image" data-aspect-ratio="{{ month.image_aspect_ratio }}">
        </div>
        
        {% if month.supports_events %}
        <!-- Events Section -->
        <div class="card mt-3">
          <div class="card-header">
            <span class="fa fa-calendar-plus me-2"></span>Termine für {{ month.name }}
          </div>
          <div class="card-body">
            <div class="list-group" id="events-group-{{ month.id }}">
            </div>
            <button type="button" class="btn btn-outline-primary mt-2" onclick="addEvent({{ month.id }}, '{{ month.date | date:'Y-m-d' }}', '')">
              <span class="fa fa-plus"></span> Termin hinzufügen
            </button>
          </div>
        </div>
        {% endif %}
      </div>
    {% endfor %}
  </div>
 
</form>

<!-- Upload Progress Modal -->
<div class="modal fade" id="upload-images-modal" tabindex="-1" aria-labelledby="upload-images-modal-label" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="upload-images-modal-label">Lade Bilder zum Server</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="progress">
          <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-label="Fortschritt" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%">0%</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Live Preview Modal -->
<div class="modal fade" id="preview-modal" tabindex="-1" aria-labelledby="preview-modal-label" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="preview-modal-label">
          <span class="fa fa-eye me-2"></span>Kalendervorschau
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Schließen"></button>
      </div>
      <div class="modal-body p-0" id="preview-modal-body" style="min-height: 500px; background: #495057;">
        <div class="preview-placeholder">
          <span class="fa fa-file-pdf"></span>
          <p>Vorschau wird geladen...</p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" onclick="generatePreviewForModal()">
          <span class="fa fa-rotate"></span> Aktualisieren
        </button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schließen</button>
        <button type="button" class="btn btn-primary" onclick="uploadImages()">
          <span class="fa fa-file-pdf"></span> PDF Erzeugen
        </button>
      </div>
    </div>
  </div>
</div>

<script>
const cropper = [];
let globalAppointmentId = 0;
let months = [ {% for month in months %}{{ month.id}}{% if not forloop.last %},{% endif %}{% endfor %} ];
let currentMonthIndex = 0;

// Month navigation functions
function getCurrentMonthId() {
  return months[currentMonthIndex];
}

function selectMonth(monthId) {
  monthId = parseInt(monthId);
  var newIndex = months.indexOf(monthId);
  if (newIndex >= 0) {
    currentMonthIndex = newIndex;
    showMonthPanel(monthId);
    updateMonthNavigation();
    syncRibbonFromMonth(monthId);
  }
}

function navigateMonth(direction) {
  var newIndex = currentMonthIndex + direction;
  if (newIndex >= 0 && newIndex < months.length) {
    currentMonthIndex = newIndex;
    var monthId = months[currentMonthIndex];
    showMonthPanel(monthId);
    document.getElementById('monthSelector').value = monthId;
    updateMonthNavigation();
    syncRibbonFromMonth(monthId);
  }
}

function showMonthPanel(monthId) {
  // Hide all month panels
  document.querySelectorAll('.month-panel').forEach(function(panel) {
    panel.classList.add('d-none');
  });
  // Show selected month panel
  var panel = document.getElementById('month_panel_' + monthId);
  if (panel) {
    panel.classList.remove('d-none');
  }
}

function updateMonthNavigation() {
  document.getElementById('prevMonthBtn').disabled = (currentMonthIndex === 0);
  document.getElementById('nextMonthBtn').disabled = (currentMonthIndex === months.length - 1);
  document.getElementById('monthCounter').textContent = (currentMonthIndex + 1) + ' / ' + months.length;
  
  // Update month title in the selector bar
  var selector = document.getElementById('monthSelector');
  var selectedOption = selector.options[selector.selectedIndex];
  if (selectedOption) {
    document.getElementById('currentMonthTitle').textContent = 'Foto für ' + selectedOption.text;
  }
}

// Sync ribbon controls from month's hidden fields
function syncRibbonFromMonth(monthId) {
  // Image border
  setButtonState('ribbon-image-border', 'field_image_border_' + monthId)
  setButtonValue('ribbon-image-border-color', 'field_image_border_color_' + monthId, '#000000')
  setButtonValue('ribbon-image-border-width', 'field_image_border_width_' + monthId, '3');

  // Background
  setButtonValue('ribbon-background-type', 'field_background_type_' + monthId, 'N');
  setButtonValue('ribbon-background-color', 'field_background_color_' + monthId, '#ffffff');
  setButtonValue('ribbon-background-color-b', 'field_background_color_b_' + monthId, '#aaaaaa');
  setButtonState('ribbon-center-month', 'field_center_month_' + monthId);
 
  // Days table
  setButtonState('ribbon-table-border', 'field_table_border_' + monthId);
  setButtonState('ribbon-show-weeks', 'field_show_weeks_' + monthId);
  setButtonValue('ribbon-table-background-color', 'field_table_background_color_' + monthId, '#ffffff');
  setButtonValue('ribbon-table-background-opacity', 'field_table_background_opacity_' + monthId, '70'); 
  
  // Fonts
  syncFontFromMonth(monthId, 'weekday');
  syncFontFromMonth(monthId, 'saturday');
  syncFontFromMonth(monthId, 'sunday');
  syncFontFromMonth(monthId, 'event');
}

function setButtonState(buttonId, valueFieldId) {
  var currentValue = document.getElementById(valueFieldId);
  var button = document.getElementById(buttonId);
  if (button) {
    if (currentValue && currentValue.value === '1') {
      button.classList.add('active');
    } else {
      button.classList.remove('active');
    }
  }
  else {
    console.warn("Button with ID " + buttonId + " not found for syncing state.");
  }
}

function setButtonValue(buttonId, valueFieldId, defaultValue) {
  var currentValue = document.getElementById(valueFieldId);
  var button = document.getElementById(buttonId);
  if (button) {
    button.value = currentValue && currentValue.value ? currentValue.value : defaultValue;  
  }
  else {
    console.warn("Button with ID " + buttonId + " not found for syncing value.");
  }
}

function syncFontFromMonth(monthId, fontType) {
  setButtonState('ribbon-font-' + fontType + '-bold', 'field_font_' + fontType + '_bold_' + monthId);
  setButtonState('ribbon-font-' + fontType + '-italic', 'field_font_' + fontType + '_italic_' + monthId);
  setButtonState('ribbon-font-' + fontType + '-underline', 'field_font_' + fontType + '_underline_' + monthId);
  setButtonValue('ribbon-font-' + fontType + '-color', 'field_font_' + fontType + '_color_' + monthId, '#000000');
}

// Update hidden field for current month from ribbon control
function updateCurrentMonthField(fieldName, value) {
  var monthId = getCurrentMonthId();
  var field = document.getElementById('field_' + fieldName + '_' + monthId);
  if (field) {
    field.value = value;
  }
}

// Helper functions for ribbon buttons
function selectImageForCurrentMonth() {
  var monthId = getCurrentMonthId();
  var img = document.getElementById('image-preview-' + monthId);
  var aspectRatio = img ? img.getAttribute('data-aspect-ratio') : '1.5';
  selectImage(monthId, aspectRatio);
}

// Rotate image for current month
function rotateCurrentImage(degrees) {
  var monthId = getCurrentMonthId();
  if (cropper[monthId]) {
    cropper[monthId].rotate(degrees);
  }
}

// Flip image for current month
var flipScaleX = {};
var flipScaleY = {};

function flipCurrentImage(direction) {
  var monthId = getCurrentMonthId();
  if (cropper[monthId]) {
    if (direction === 'horizontal') {
      // Initialize if not set
      if (flipScaleX[monthId] === undefined) flipScaleX[monthId] = 1;
      flipScaleX[monthId] = flipScaleX[monthId] === -1 ? 1 : -1;
      cropper[monthId].scaleX(flipScaleX[monthId]);
    } else if (direction === 'vertical') {
      // Initialize if not set
      if (flipScaleY[monthId] === undefined) flipScaleY[monthId] = 1;
      flipScaleY[monthId] = flipScaleY[monthId] === -1 ? 1 : -1;
      cropper[monthId].scaleY(flipScaleY[monthId]);
    }
  }
}

function addEventForCurrentMonth() {
  var monthId = getCurrentMonthId();
  var panel = document.getElementById('month_panel_' + monthId);
  var dateField = panel ? panel.querySelector('input[name="date_' + monthId + '"]') : null;
  var date = dateField ? dateField.value : new Date().toISOString().split('T')[0];
  addEvent(monthId, date, '');
}

// Preview Modal functions
var previewModalInstance = null;

function showPreviewModal() {
  var modalEl = document.getElementById('preview-modal');
  previewModalInstance = bootstrap.Modal.getOrCreateInstance(modalEl);
  previewModalInstance.show();
  
  // Generate preview when modal is shown
  modalEl.addEventListener('shown.bs.modal', function() {
    generatePreviewForModal();
  }, { once: true });
}

function generatePreviewForModal() {
  var monthId = getCurrentMonthId();
  var container = document.getElementById('preview-modal-body');
  
  // Show loading state
  container.innerHTML = '<div class="preview-loading"><div class="spinner-border text-light" role="status"><span class="visually-hidden">Laden...</span></div><p>Vorschau wird erstellt...</p></div>';
  
  // Collect form data for the specific month
  var formData = new FormData(document.forms['months']);
  formData.set('lenght', '1');
  formData.set('ids', monthId + ',');
  
  var croppedCanvasOptions = {
    minWidth: 256,
    minHeight: 256,
    maxWidth: 2048,
    maxHeight: 2048,
  };
  
  if (cropper[monthId]) {
    var boxData = cropper[monthId].getData();
    formData.set("image_x_" + monthId, boxData['x']);
    formData.set("image_y_" + monthId, boxData['y']);
    formData.set("image_width_" + monthId, boxData['width']);
    formData.set("image_height_" + monthId, boxData['height']);
    
    cropper[monthId].getCroppedCanvas(croppedCanvasOptions).toBlob(function(blob) {
      formData.append('image_' + monthId, blob, 'image_' + monthId + '.jpeg');
      sendModalPreviewRequest(formData, container);
    }, 'image/jpeg', 0.8);
  } else {
    sendModalPreviewRequest(formData, container);
  }
}

function sendModalPreviewRequest(formData, container) {
  var xhr = new XMLHttpRequest();
  xhr.open("POST", "create", true);
  xhr.responseType = 'blob';
  
  xhr.onload = function() {
    if (xhr.status === 200) {
      var pdfUrl = window.URL.createObjectURL(xhr.response);
      container.innerHTML = '<object data="' + pdfUrl + '" type="application/pdf" width="100%" height="600px" style="background: white;"><p>PDF Vorschau kann nicht angezeigt werden. <a href="' + pdfUrl + '" target="_blank">PDF herunterladen</a></p></object>';
    } else {
      container.innerHTML = '<div class="preview-placeholder"><span class="fa fa-exclamation-triangle"></span><p>Vorschau konnte nicht erstellt werden.<br>Bitte versuchen Sie es erneut.</p></div>';
    }
  };
  
  xhr.onerror = function() {
    container.innerHTML = '<div class="preview-placeholder"><span class="fa fa-exclamation-triangle"></span><p>Netzwerkfehler.<br>Bitte überprüfen Sie Ihre Verbindung.</p></div>';
  };
  
  xhr.send(formData);
}

// Initialize on document ready
$(document).ready(function() {
  updateMonthNavigation();
  syncRibbonFromMonth(getCurrentMonthId());
  
  {% for month in months %}
    {% for event in month.events %}
    addEvent({{month.id}}, '{{ event.date }}', '{{ event.text }}', true);
    {% endfor %}
    {% if month.image %}setCropperImage('{{ month.id }}', '{{month.image_aspect_ratio}}', false, 'data:image/jpeg;base64,{{ month.image }}'){% endif %}
  {% endfor %}
});
</script>
<script src="{% static 'calendaronline.js' %}"></script>
{% endblock %}
