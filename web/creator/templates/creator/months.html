{% extends "master.html" %}
{% load static %}
{% load prefix %}

{% block title %}
  Neuen Kalender erzeugen
{% endblock %}

{% block head %}
  <link href="{% static 'cropper.js-1.6.2/cropper.min.css' %}" rel="stylesheet">
  <link href="{% static 'ribbon.css' %}" rel="stylesheet">
  <script src="{% static 'cropper.js-1.6.2/cropper.min.js' %}">
    import Cropper from 'cropperjs';
  </script>
{% endblock %}

{% block content %}
<form enctype="multipart/form-data" name="months">
  {% csrf_token %} 
  <input type="hidden" name="format" value="{{ format }}" />
  <input type="hidden" name="ids" value="{% for month in months %}{{month.id}},{% endfor %}" />
  <input type="hidden" name="lenght" value="{{ months|length }}" />
  <input type="hidden" name="save_project" value="0" />

  <ul class="nav nav-tabs" id="monthTabs" role="tablist">
    {% for month in months %}
      <li class="nav-item" role="presentation">
        <button class="nav-link{% if forloop.first %} active{% endif %}" id="month_tab_{{ month.id }}" data-bs-toggle="tab" data-bs-target="#month_pane_{{ month.id }}" type="button" role="tab" aria-controls="month_pane_{{ month.id }}" aria-selected="{% if forloop.first %}true{% else %}false{% endif %}">{{ month.name }}</button>
      </li>  
    {% endfor %}
  </ul>
  <div class="tab-content" id="monthTabsContent">
    {% for month in months %}
      <div class="tab-pane fade{% if forloop.first %} show active{% endif %}" id="month_pane_{{ month.id }}" role="tabpanel" aria-labelledby="month_tab_{{ month.id }}" tabindex="0">
        <input type="hidden" name="id_{{ month.id }}" value="{{ month.id }}" />
        <input type="hidden" name="name_{{ month.id }}" value="{{ month.name }}" />
        <input type="hidden" name="date_{{ month.id }}" value="{{ month.date | date:'Y-m-d' }}" />
        
        <div class="container-fluid pt-3">
          <!-- Ribbon UI for Design Options -->
          <div class="ribbon-container mb-3">
            <ul class="nav ribbon-tabs" id="ribbonTabs{{ month.id }}" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="ribbon-image-tab-{{ month.id }}" data-bs-toggle="tab" data-bs-target="#ribbon-image-{{ month.id }}" type="button" role="tab">
                  <span class="fa fa-image me-1"></span> Bild
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="ribbon-background-tab-{{ month.id }}" data-bs-toggle="tab" data-bs-target="#ribbon-background-{{ month.id }}" type="button" role="tab">
                  <span class="fa fa-palette me-1"></span> Hintergrund
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="ribbon-days-tab-{{ month.id }}" data-bs-toggle="tab" data-bs-target="#ribbon-days-{{ month.id }}" type="button" role="tab">
                  <span class="fa fa-calendar-days me-1"></span> Tagesliste
                </button>
              </li>
              {% if month.supports_fonts %}
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="ribbon-fonts-tab-{{ month.id }}" data-bs-toggle="tab" data-bs-target="#ribbon-fonts-{{ month.id }}" type="button" role="tab">
                  <span class="fa fa-font me-1"></span> Schriften
                </button>
              </li>
              {% endif %}
              {% if month.supports_events %}
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="ribbon-events-tab-{{ month.id }}" data-bs-toggle="tab" data-bs-target="#ribbon-events-{{ month.id }}" type="button" role="tab">
                  <span class="fa fa-calendar-plus me-1"></span> Termine
                </button>
              </li>
              {% endif %}
            </ul>
            <div class="tab-content ribbon-content">
              <!-- Image Tab -->
              <div class="tab-pane fade show active" id="ribbon-image-{{ month.id }}" role="tabpanel">
                <div class="ribbon-row">
                  <div class="ribbon-group">
                    <div class="ribbon-group-content">
                      <button type="button" class="ribbon-btn ribbon-btn-lg" title="Neues Bild öffnen" onclick="selectImage('{{ month.id }}', '{{month.image_aspect_ratio}}')">
                        <span class="fa fa-folder-open"></span>
                        <span class="ribbon-btn-label">Bild öffnen</span>
                      </button>
                    </div>
                    <span class="ribbon-group-label">Datei</span>
                  </div>
                  <div class="ribbon-group">
                    <div class="ribbon-group-content">
                      <div class="ribbon-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="image_border_{{ month.id }}" name="image_border_{{ month.id }}" value="1"{% if month.image_border %} checked{% endif %} onchange="updateLivePreview({{ month.id }})">
                        <span class="ribbon-switch-label">Rahmen</span>
                      </div>
                      <div class="ribbon-control">
                        <span class="ribbon-control-label">Farbe</span>
                        <input class="form-control form-control-color" type="color" id="image-border-color_{{ month.id }}" name="image_border_color_{{ month.id }}" value="{{ month.image_border_color }}" onchange="updateLivePreview({{ month.id }})">
                      </div>
                      <div class="ribbon-control">
                        <span class="ribbon-control-label">Breite</span>
                        <input type="range" class="form-range ribbon-slider" min="0" max="100" value="{{ month.image_border_width }}" id="image-border-width_{{ month.id }}" name="image_border_width_{{ month.id }}" onchange="updateLivePreview({{ month.id }})">
                      </div>
                    </div>
                    <span class="ribbon-group-label">Bildrahmen</span>
                  </div>
                  <div class="ribbon-group">
                    <div class="ribbon-group-content">
                      <button type="button" class="ribbon-btn" title="Vorschau aktualisieren" onclick="updateLivePreview({{ month.id }})">
                        <span class="fa fa-rotate"></span>
                        <span class="ribbon-btn-label">Aktualisieren</span>
                      </button>
                    </div>
                    <span class="ribbon-group-label">Vorschau</span>
                  </div>
                </div>
              </div>
              
              <!-- Background Tab -->
              <div class="tab-pane fade" id="ribbon-background-{{ month.id }}" role="tabpanel">
                <div class="ribbon-row">
                  <div class="ribbon-group">
                    <div class="ribbon-group-content">
                      <div class="ribbon-control">
                        <span class="ribbon-control-label">Art</span>
                        <select class="form-select" id="background-type_{{ month.id }}" name="background_type_{{ month.id }}" style="width: 150px;" onchange="updateLivePreview({{ month.id }})">
                          <option value="N"{% if month.background_type == "N" %} selected{% endif %}>Keine</option>
                          <option value="S"{% if month.background_type == "S" %} selected{% endif %}>Einfarbig</option>
                          <option value="H"{% if month.background_type == 'H' %} selected{% endif %}>Horizontal</option>
                          <option value="V"{% if month.background_type == 'V' %} selected{% endif %}>Vertikal</option>
                          <option value="D"{% if month.background_type == 'D' %} selected{% endif %}>Diagonal</option>
                          <option value="R"{% if month.background_type == 'R' %} selected{% endif %}>Kreisförmig</option>
                        </select>
                      </div>
                    </div>
                    <span class="ribbon-group-label">Typ</span>
                  </div>
                  <div class="ribbon-group">
                    <div class="ribbon-group-content">
                      <div class="ribbon-control">
                        <span class="ribbon-control-label">Farbe 1</span>
                        <input class="form-control form-control-color" type="color" id="background-color_{{ month.id }}" name="background_color_{{ month.id }}" value="{{ month.background_color }}" onchange="updateLivePreview({{ month.id }})">
                      </div>
                      <div class="ribbon-control">
                        <span class="ribbon-control-label">Farbe 2</span>
                        <input class="form-control form-control-color" type="color" id="background-color-b_{{ month.id }}" name="background_color_b_{{ month.id }}" value="{{ month.background_color_b }}" onchange="updateLivePreview({{ month.id }})">
                      </div>
                    </div>
                    <span class="ribbon-group-label">Farben</span>
                  </div>
                  <div class="ribbon-group">
                    <div class="ribbon-group-content">
                      <div class="ribbon-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="center-month_{{ month.id }}" name="center_month_{{ month.id }}" value="1"{% if month.month_align == 'C' %} checked{% endif %} onchange="updateLivePreview({{ month.id }})">
                        <span class="ribbon-switch-label">Monat zentriert</span>
                      </div>
                    </div>
                    <span class="ribbon-group-label">Ausrichtung</span>
                  </div>
                </div>
              </div>
              
              <!-- Days List Tab -->
              <div class="tab-pane fade" id="ribbon-days-{{ month.id }}" role="tabpanel">
                <div class="ribbon-row">
                  <div class="ribbon-group">
                    <div class="ribbon-group-content">
                      <div class="ribbon-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="table-border_{{ month.id }}" name="table_border_{{ month.id }}" value="1"{% if month.table_border %} checked{% endif %} onchange="updateLivePreview({{ month.id }})">
                        <span class="ribbon-switch-label">Rahmen</span>
                      </div>
                      {% if month.supports_weeks %}
                      <div class="ribbon-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="show-weeks_{{ month.id }}" name="show_weeks_{{ month.id }}" value="1"{% if month.show_weeks %} checked{% endif %} onchange="updateLivePreview({{ month.id }})">
                        <span class="ribbon-switch-label">KW anzeigen</span>
                      </div>
                      {% endif %}
                    </div>
                    <span class="ribbon-group-label">Optionen</span>
                  </div>
                  <div class="ribbon-group">
                    <div class="ribbon-group-content">
                      <div class="ribbon-control">
                        <span class="ribbon-control-label">Hintergrund</span>
                        <input class="form-control form-control-color" type="color" id="table-background-color_{{ month.id }}" name="table_background_color_{{ month.id }}" value="{{ month.table_background_color }}" onchange="updateLivePreview({{ month.id }})">
                      </div>
                      <div class="ribbon-control">
                        <span class="ribbon-control-label">Transparenz</span>
                        <input type="range" class="form-range ribbon-slider" min="0" max="100" value="{{ month.table_background_opacity }}" id="table-background-opacity_{{ month.id }}" name="table_background_opacity_{{ month.id }}" onchange="updateLivePreview({{ month.id }})">
                      </div>
                    </div>
                    <span class="ribbon-group-label">Hintergrund</span>
                  </div>
                </div>
              </div>
              
              {% if month.supports_fonts %}
              <!-- Fonts Tab -->
              <div class="tab-pane fade" id="ribbon-fonts-{{ month.id }}" role="tabpanel">
                <div class="ribbon-row">
                  <div class="ribbon-group">
                    <div class="ribbon-group-content">
                      <div class="ribbon-inline">
                        <div class="ribbon-font-buttons btn-group" role="group">
                          <input type="checkbox" class="btn-check" id="font_weekday_bold_{{ month.id }}" name="font_weekday_bold_{{ month.id }}" value="1"{% if month.fonts.weekday.bold %} checked{% endif %}>
                          <label class="btn btn-outline-primary btn-sm" for="font_weekday_bold_{{ month.id }}"><span class="fa fa-bold"></span></label>
                          <input type="checkbox" class="btn-check" id="font_weekday_italic_{{ month.id }}" name="font_weekday_italic_{{ month.id }}" value="1"{% if not month.supports_italic %} disabled{% elif month.fonts.weekday.italic %} checked{% endif %}>
                          <label class="btn btn-outline-primary btn-sm" for="font_weekday_italic_{{ month.id }}"><span class="fa fa-italic"></span></label>
                          <input type="checkbox" class="btn-check" id="font_weekday_underline_{{ month.id }}" name="font_weekday_underline_{{ month.id }}" value="1"{% if month.fonts.weekday.underline %} checked{% endif %}>
                          <label class="btn btn-outline-primary btn-sm" for="font_weekday_underline_{{ month.id }}"><span class="fa fa-underline"></span></label>
                        </div>
                        <input class="form-control form-control-color" type="color" name="font_weekday_color_{{ month.id }}" value="{{ month.fonts.weekday.color }}" style="width:28px;height:28px;">
                      </div>
                    </div>
                    <span class="ribbon-group-label">Wochentage</span>
                  </div>
                  <div class="ribbon-group">
                    <div class="ribbon-group-content">
                      <div class="ribbon-inline">
                        <div class="ribbon-font-buttons btn-group" role="group">
                          <input type="checkbox" class="btn-check" id="font_saturday_bold_{{ month.id }}" name="font_saturday_bold_{{ month.id }}" value="1"{% if month.fonts.saturday.bold %} checked{% endif %}>
                          <label class="btn btn-outline-primary btn-sm" for="font_saturday_bold_{{ month.id }}"><span class="fa fa-bold"></span></label>
                          <input type="checkbox" class="btn-check" id="font_saturday_italic_{{ month.id }}" name="font_saturday_italic_{{ month.id }}" value="1"{% if not month.supports_italic %} disabled{% elif month.fonts.saturday.italic %} checked{% endif %}>
                          <label class="btn btn-outline-primary btn-sm" for="font_saturday_italic_{{ month.id }}"><span class="fa fa-italic"></span></label>
                          <input type="checkbox" class="btn-check" id="font_saturday_underline_{{ month.id }}" name="font_saturday_underline_{{ month.id }}" value="1"{% if month.fonts.saturday.underline %} checked{% endif %}>
                          <label class="btn btn-outline-primary btn-sm" for="font_saturday_underline_{{ month.id }}"><span class="fa fa-underline"></span></label>
                        </div>
                        <input class="form-control form-control-color" type="color" name="font_saturday_color_{{ month.id }}" value="{{ month.fonts.saturday.color }}" style="width:28px;height:28px;">
                      </div>
                    </div>
                    <span class="ribbon-group-label">Samstage</span>
                  </div>
                  <div class="ribbon-group">
                    <div class="ribbon-group-content">
                      <div class="ribbon-inline">
                        <div class="ribbon-font-buttons btn-group" role="group">
                          <input type="checkbox" class="btn-check" id="font_sunday_bold_{{ month.id }}" name="font_sunday_bold_{{ month.id }}" value="1"{% if month.fonts.sunday.bold %} checked{% endif %}>
                          <label class="btn btn-outline-primary btn-sm" for="font_sunday_bold_{{ month.id }}"><span class="fa fa-bold"></span></label>
                          <input type="checkbox" class="btn-check" id="font_sunday_italic_{{ month.id }}" name="font_sunday_italic_{{ month.id }}" value="1"{% if not month.supports_italic %} disabled{% elif month.fonts.sunday.italic %} checked{% endif %}>
                          <label class="btn btn-outline-primary btn-sm" for="font_sunday_italic_{{ month.id }}"><span class="fa fa-italic"></span></label>
                          <input type="checkbox" class="btn-check" id="font_sunday_underline_{{ month.id }}" name="font_sunday_underline_{{ month.id }}" value="1"{% if month.fonts.sunday.underline %} checked{% endif %}>
                          <label class="btn btn-outline-primary btn-sm" for="font_sunday_underline_{{ month.id }}"><span class="fa fa-underline"></span></label>
                        </div>
                        <input class="form-control form-control-color" type="color" name="font_sunday_color_{{ month.id }}" value="{{ month.fonts.sunday.color }}" style="width:28px;height:28px;">
                      </div>
                    </div>
                    <span class="ribbon-group-label">Sonntage</span>
                  </div>
                  <div class="ribbon-group">
                    <div class="ribbon-group-content">
                      <div class="ribbon-inline">
                        <div class="ribbon-font-buttons btn-group" role="group">
                          <input type="checkbox" class="btn-check" id="font_event_bold_{{ month.id }}" name="font_event_bold_{{ month.id }}" value="1"{% if month.fonts.event.bold %} checked{% endif %}>
                          <label class="btn btn-outline-primary btn-sm" for="font_event_bold_{{ month.id }}"><span class="fa fa-bold"></span></label>
                          <input type="checkbox" class="btn-check" id="font_event_italic_{{ month.id }}" name="font_event_italic_{{ month.id }}" value="1"{% if not month.supports_italic %} disabled{% elif month.fonts.event.italic %} checked{% endif %}>
                          <label class="btn btn-outline-primary btn-sm" for="font_event_italic_{{ month.id }}"><span class="fa fa-italic"></span></label>
                          <input type="checkbox" class="btn-check" id="font_event_underline_{{ month.id }}" name="font_event_underline_{{ month.id }}" value="1"{% if month.fonts.event.underline %} checked{% endif %}>
                          <label class="btn btn-outline-primary btn-sm" for="font_event_underline_{{ month.id }}"><span class="fa fa-underline"></span></label>
                        </div>
                        <input class="form-control form-control-color" type="color" name="font_event_color_{{ month.id }}" value="{{ month.fonts.event.color }}" style="width:28px;height:28px;">
                      </div>
                    </div>
                    <span class="ribbon-group-label">Termine</span>
                  </div>
                </div>
              </div>
              {% endif %}
              
              {% if month.supports_events %}
              <!-- Events Tab -->
              <div class="tab-pane fade" id="ribbon-events-{{ month.id }}" role="tabpanel">
                <div class="ribbon-row">
                  <div class="ribbon-group">
                    <div class="ribbon-group-content">
                      <button type="button" class="ribbon-btn ribbon-btn-lg" onclick="addEvent({{ month.id }}, '{{ month.date | date:'Y-m-d' }}', '')">
                        <span class="fa fa-calendar-plus"></span>
                        <span class="ribbon-btn-label">Hinzufügen</span>
                      </button>
                    </div>
                    <span class="ribbon-group-label">Neuer Termin</span>
                  </div>
                </div>
                <div class="mt-3">
                  <div class="list-group" id="events-group-{{ month.id }}">
                  </div>
                </div>
              </div>
              {% endif %}
            </div>
          </div>

          <!-- Main Content Area with Live Preview -->
          <div class="row">
            <!-- Image Editor Column -->
            <div class="col-lg-7 col-xl-8 mb-3">
              <div class="card">
                <div class="card-header bg-success text-white">
                  <span class="fa fa-image me-2"></span>Foto für {{ month.name }}
                </div>
                <div class="card-body text-center p-3">
                  <img id="image-preview-{{ month.id }}" src="{% static 'images/no_image_16x9.png' %}" alt="Vorschau" class="img-fluid" style="max-height:500px">
                </div>
                <div class="card-footer">
                  <div class="d-flex justify-content-between flex-wrap gap-2">
                    <div class="btn-group">
                      <button type="button" class="btn btn-success" title="Neues Bild öffnen" onclick="selectImage('{{ month.id }}', '{{month.image_aspect_ratio}}')">
                        <span class="fa fa-folder-open"></span> Bild öffnen
                      </button>
                    </div>
                    <div class="btn-group">
                      <button type="button" class="btn btn-outline-primary" title="Vorschau aktualisieren" onclick="updateLivePreview({{ month.id }})">
                        <span class="fa fa-rotate"></span> Vorschau
                      </button>
                      <button type="button" class="btn {% if forloop.last %}btn-primary{% else %}btn-outline-secondary{% endif %}" title="Kalender erzeugen" onclick="uploadImages()">
                        <span class="fa fa-file-pdf"></span> PDF Erzeugen
                      </button>
                    </div>
                    <div class="btn-group">
                      <button type="button" class="btn btn-outline-secondary" title="Nächster Monat" onclick="showTab('month_tab_{{ month.id|add:1}}')"{% if forloop.last %} disabled{% endif %}>
                        <span class="fa fa-arrow-right"></span> Weiter
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Live Preview Column -->
            <div class="col-lg-5 col-xl-4 mb-3">
              <div class="preview-panel">
                <div class="preview-panel-header">
                  <span><span class="fa fa-eye me-2"></span>Live-Vorschau</span>
                  <button type="button" class="btn btn-sm btn-outline-light" onclick="updateLivePreview({{ month.id }})" title="Vorschau aktualisieren">
                    <span class="fa fa-rotate"></span>
                  </button>
                </div>
                <div class="preview-panel-body" id="preview-container-{{ month.id }}">
                  <div class="preview-placeholder">
                    <span class="fa fa-file-pdf"></span>
                    <p>Klicken Sie auf "Vorschau" um eine<br>Live-Vorschau zu generieren</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
        </div>
      </div>
      
    {% endfor %}
  </div>
 
</form>
<!-- Modal -->
<div class="modal fade" id="upload-images-modal" tabindex="-1" aria-labelledby="upload-images-modal-label" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="upload-images-modal-label">Lade Bilder zum Server</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="progress">
          <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-label="Fortschritt" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%">0%</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>

const cropper = [];
let globalAppointmentId = 0;
let months = [ {% for month in months %}{{ month.id}}{% if not forloop.last %},{% endif %}{% endfor %} ];

{% if months.0.supports_events %}
$( document ).ready(function() {
  {% for month in months %}
    {% for event in month.events %}
    addEvent({{month.id}}, '{{ event.date }}', '{{ event.text }}', true);
    {% endfor %}
    {% if month.image %}setCropperImage('{{ month.id }}', '{{month.image_aspect_ratio}}', false, 'data:image/jpeg;base64,{{ month.image }}'){% endif %}
  {% endfor %}
});
{% endif %} 
</script>
<script src="{% static 'calendaronline.js' %}"></script>
{% endblock %}